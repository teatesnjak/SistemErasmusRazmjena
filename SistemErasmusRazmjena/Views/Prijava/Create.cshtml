@model SistemErasmusRazmjena.Models.ViewModels.PrijavaCreateViewModel

@{
    ViewData["Title"] = "Nova prijava";
}

<h2>Nova prijava</h2>

<form asp-action="Create" method="post">
    @* Hidden polja – OBAVEZNO *@
    <input type="hidden" asp-for="ErasmusProgramID" />
    <input type="hidden" asp-for="StudentID" />
    <input type="hidden" asp-for="Status" />

    <div>
        <h3>Erasmus Program Details</h3>
        <p><strong>Akademska godina:</strong> @Model.AkademskaGodina</p>
        <p><strong>Naziv:</strong> @Model.Naziv</p>
        <p><strong>Semestar:</strong> @Model.Semestar</p>
        <p><strong>Opis:</strong> @Model.Opis</p>
    </div>

    <div>
        <h3>Documentation</h3>
        <label>
            <input type="checkbox" asp-for="DokumentacijaOptions.CV" /> CV
        </label>
        <label>
            <input type="checkbox" asp-for="DokumentacijaOptions.MotivacionoPismo" /> Motivational Letter
        </label>
        <label>
            <input type="checkbox" asp-for="DokumentacijaOptions.UgovorOUcenju" /> Learning Agreement
        </label>
    </div>

    <div>
        <h3>Subjects</h3>
        <table id="subjectsTable" class="table">
            <thead>
                <tr>
                    <th>Home University Subject</th>
                    <th>Accepting University Subject</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="subjectRows">
                <tr class="subject-row">
                    <td>
                        <input type="text" name="PrijedlogPredmeta[0].PredmetHome" class="form-control" required />
                    </td>
                    <td>
                        <input type="text" name="PrijedlogPredmeta[0].PredmetAccepting" class="form-control" required />
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger remove-row">Remove</button>
                    </td>
                </tr>
            </tbody>
        </table>
        <button type="button" id="addSubjectRow" class="btn btn-primary">Add Subject</button>
    </div>

    <div class="card-body mt-4">
        <div class="d-grid gap">
            <button type="submit" class="btn btn-success">Submit</button>
        </div>
    </div>
</form>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Handle adding new row
            $("#addSubjectRow").click(function() {
                let rowCount = $("#subjectRows .subject-row").length;
                let newRow = `
                    <tr class="subject-row">
                        <td>
                            <input type="text" name="PrijedlogPredmeta[${rowCount}].PredmetHome" class="form-control" required />
                        </td>
                        <td>
                            <input type="text" name="PrijedlogPredmeta[${rowCount}].PredmetAccepting" class="form-control" required />
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger remove-row">Remove</button>
                        </td>
                    </tr>
                `;
                $("#subjectRows").append(newRow);
            });

            // Handle removing row (delegated event for dynamically added elements)
            $("#subjectsTable").on("click", ".remove-row", function() {
                // Don't remove if it's the last row
                if ($("#subjectRows .subject-row").length > 1) {
                    $(this).closest("tr").remove();

                    // Renumber the inputs to ensure they're sequential
                    $("#subjectRows .subject-row").each(function(index) {
                        $(this).find("input").each(function() {
                            let name = $(this).attr("name");
                            let newName = name.replace(/\[\d+\]/, `[${index}]`);
                            $(this).attr("name", newName);
                        });
                    });
                } else {
                    // If it's the last row, just clear the inputs
                    $(this).closest("tr").find("input").val("");
                }
            });

            // Validate form on submit
            $("form").on("submit", function(e) {
                let isValid = true;

                // Check if any subject rows are empty
                $(".subject-row").each(function() {
                    const homeSubject = $(this).find("input[name$='.PredmetHome']").val();
                    const acceptingSubject = $(this).find("input[name$='.PredmetAccepting']").val();

                    if (!homeSubject || !acceptingSubject) {
                        isValid = false;
                        // Mark the empty inputs
                        if (!homeSubject) $(this).find("input[name$='.PredmetHome']").addClass("is-invalid");
                        if (!acceptingSubject) $(this).find("input[name$='.PredmetAccepting']").addClass("is-invalid");
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    alert("Please fill in both home and accepting university subjects for all rows.");
                }
            });
        });
    </script>
}

